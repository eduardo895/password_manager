<!DOCTYPE html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor de Palavras-passe</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(160deg, #1f2937, #111827);
        color: #f9fafb;
      }

      body {
        margin: 0;
        min-height: 100vh;
      }

      /* === üîê Ecr√£ de autentica√ß√£o === */
      #auth-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        gap: 16px;
        background: linear-gradient(160deg, #1e293b, #0f172a);
      }

      #auth-screen h2 {
        font-size: 1.9rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      #auth-message {
        color: #94a3b8;
        font-size: 0.95rem;
      }

      #auth-screen input {
        width: 240px;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.9);
        color: #f9fafb;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      #auth-screen input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      }

      #auth-screen button {
        width: 240px;
        padding: 12px;
        border-radius: 9999px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border: none;
        color: #f8fafc;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      #auth-screen button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(99, 102, 241, 0.35);
      }

      /* === üíæ Painel principal === */
      main {
        display: none;
        width: min(900px, 95vw);
        margin: 40px auto;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 18px;
        padding: 32px 36px 40px;
        box-shadow: 0 32px 80px rgba(15, 15, 30, 0.45);
      }

      h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .subtitle {
        color: #94a3b8;
        margin-bottom: 1rem;
      }

      .encryption-status {
        color: #86efac;
        font-size: 0.9rem;
        margin-bottom: 2rem;
      }

      form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 28px;
      }

      label {
        display: flex;
        flex-direction: column;
        font-size: 0.85rem;
        color: #cbd5f5;
        gap: 8px;
      }

      input {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 10px;
        padding: 12px 14px;
        color: inherit;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.35);
      }

      button {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border: none;
        border-radius: 9999px;
        color: #f8fafc;
        padding: 12px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 20px rgba(99, 102, 241, 0.3);
      }

      /* üé≤ Sec√ß√£o de gera√ß√£o */
      .password-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .password-input-group input {
        flex: 1;
      }

      #generate-btn {
      width: 48px;
      height: 48px;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    #generate-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35);
    }




      .password-options {
        grid-column: 1 / -1;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        margin-top: -8px;
        font-size: 0.85rem;
        color: #cbd5f5;
      }

      .password-options label {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .password-options input[type="number"] {
        width: 60px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 8px;
        padding: 4px 6px;
        color: inherit;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 14px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
      }

      thead {
        background: rgba(99, 102, 241, 0.15);
      }

      th,
      td {
        padding: 14px 18px;
        text-align: left;
      }

      tbody tr {
        border-top: 1px solid rgba(148, 163, 184, 0.1);
      }

      tbody tr:hover {
        background: rgba(99, 102, 241, 0.1);
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .ghost-button {
        background: rgba(148, 163, 184, 0.16);
        color: #e2e8f0;
        border-radius: 12px;
        padding: 8px 14px;
        font-size: 0.85rem;
        border: none;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .ghost-button:hover {
        background: rgba(148, 163, 184, 0.24);
      }

      .danger {
        background: rgba(239, 68, 68, 0.22);
        color: #fecaca;
      }

      .danger:hover {
        background: rgba(239, 68, 68, 0.35);
      }

      .empty-state {
        text-align: center;
        color: #94a3b8;
        padding: 40px 0;
      }

      .feedback {
        margin-top: 12px;
        font-size: 0.9rem;
        color: #86efac;
        min-height: 1.2rem;
      }

      @media (max-width: 600px) {
        .password-options {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <!-- üîê Ecr√£ de autentica√ß√£o -->
    <div id="auth-screen">
      <h2>üîê Aceder ao Password Manager</h2>
      <p id="auth-message">Introduza a sua master password</p>
      <input type="password" id="master-password" placeholder="Master password ou PIN" />
      <button id="auth-button">Entrar</button>
    </div>

    <!-- üíæ Ecr√£ principal -->
    <main>
      <h1>Gestor de Palavras-passe</h1>
      <p class="subtitle">Registe, edite e elimine credenciais com seguran√ßa.</p>
      <p class="encryption-status">üîê Armazenamento cifrado (AES-256-GCM)</p>

      <form id="password-form">
        <input type="hidden" id="password-id" />
        <label>Servi√ßo <input id="service" placeholder="Ex: GitHub" required /></label>
        <label>Utilizador <input id="username" placeholder="Ex: maria.silva" required /></label>
        <label>Palavra-passe
          <div class="password-input-group">
            <input id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
            <button type="button" id="generate-btn" title="Gerar senha segura">üé≤</button>
          </div>
        </label>

        <div class="password-options">
          <label><input type="checkbox" id="use-lowercase" checked /> Min√∫sculas</label>
          <label><input type="checkbox" id="use-uppercase" checked /> Mai√∫sculas</label>
          <label><input type="checkbox" id="use-numbers" checked /> N√∫meros</label>
          <label><input type="checkbox" id="use-symbols" /> S√≠mbolos</label>
          <label>Tamanho: <input type="number" id="password-length" min="6" max="64" value="16" /></label>
        </div>

        <button type="submit" id="submit-btn">Guardar credencial</button>
      </form>

      <div class="feedback" id="feedback"></div>
      <table>
        <thead>
          <tr>
            <th>Servi√ßo</th>
            <th>Utilizador</th>
            <th>Palavra-passe</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="password-list"></tbody>
      </table>
      <p class="empty-state" id="empty-state" hidden>Ainda n√£o existem credenciais registadas.</p>
    </main>

    <script type="module">
      import { invoke } from "https://esm.sh/@tauri-apps/api/core";
      const authScreen = document.querySelector("#auth-screen");
      const mainScreen = document.querySelector("main");
      const authButton = document.querySelector("#auth-button");
      const masterInput = document.querySelector("#master-password");
      const authMsg = document.querySelector("#auth-message");

      authButton.addEventListener("click", async () => {
        const master = masterInput.value.trim();
        if (!master) return;
        try {
          const exists = await invoke("verify_master_password", { password: master });
          if (!exists) {
            await invoke("set_master_password", { password: master });
            alert("Master password criada com sucesso!");
          }
          await invoke("load_store", { master });
          authScreen.style.display = "none";
          mainScreen.style.display = "block";
          await refreshList();
        } catch {
          authMsg.textContent = "‚ùå Master password incorreta";
          authMsg.style.color = "#f87171";
        }
      });

      const form = document.querySelector("#password-form");
      const serviceInput = document.querySelector("#service");
      const usernameInput = document.querySelector("#username");
      const passwordInput = document.querySelector("#password");
      const listElement = document.querySelector("#password-list");
      const feedback = document.querySelector("#feedback");
      const generateBtn = document.querySelector("#generate-btn");
      const useLowercase = document.querySelector("#use-lowercase");
      const useUppercase = document.querySelector("#use-uppercase");
      const useNumbers = document.querySelector("#use-numbers");
      const useSymbols = document.querySelector("#use-symbols");
      const passwordLength = document.querySelector("#password-length");

      generateBtn.addEventListener("click", async () => {
        try {
          const password = await invoke("generate_password", {
            length: parseInt(passwordLength.value),
            useUppercase: useUppercase.checked,
            useLowercase: useLowercase.checked,
            useNumbers: useNumbers.checked,
            useSymbols: useSymbols.checked,
          });
          passwordInput.value = password;
          showFeedback("Senha segura gerada!");
        } catch {
          showFeedback("Erro ao gerar senha", true);
        }
      });

      window.editEntry = (id) => {
      const entry = Array.from(document.querySelectorAll("#password-list tr"))
        .map((row) => {
          const cells = row.querySelectorAll("td");
          return {
            id,
            service: cells[0].textContent,
            username: cells[1].textContent,
            password: cells[2].textContent,
          };
        })
        .find((e) => e.id === id);

      if (!entry) return;

      document.querySelector("#service").value = entry.service;
      document.querySelector("#username").value = entry.username;
      document.querySelector("#password").value = entry.password;
      document.querySelector("#password-id").value = entry.id;
      document.querySelector("#submit-btn").textContent = "Atualizar credencial";
      form.dataset.editing = "true";
    };


      form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        service: serviceInput.value.trim(),
        username: usernameInput.value.trim(),
        password: passwordInput.value.trim(),
      };

      if (form.dataset.editing === "true") {
        await invoke("update_password", {
          id: document.querySelector("#password-id").value,
          ...payload,
        });
        showFeedback("Credencial atualizada!");
        form.dataset.editing = "false";
        document.querySelector("#submit-btn").textContent = "Guardar credencial";
      } else {
        await invoke("add_password", payload);
        showFeedback("Credencial registada!");
      }

      form.reset();
      await refreshList();
    });


      async function refreshList() {
        const entries = await invoke("list_passwords").catch(() => []);
        listElement.innerHTML = entries
          .map(
            (e) => `
          <tr>
            <td>${e.service}</td>
            <td>${e.username}</td>
            <td>${e.password}</td>
            <td>
              <div class="actions">
                <button class="ghost-button" onclick="editEntry('${e.id}')">Editar</button>
                <button class="ghost-button danger" onclick="deleteEntry('${e.id}')">Eliminar</button>
              </div>
            </td>
          </tr>`
          )
          .join("");
      }

      window.deleteEntry = async (id) => {
        if (!confirm("Eliminar esta credencial?")) return;
        await invoke("delete_password", { id });
        await refreshList();
      };

      function showFeedback(msg, err = false) {
        feedback.textContent = msg;
        feedback.style.color = err ? "#f87171" : "#86efac";
        setTimeout(() => (feedback.textContent = ""), 3000);
      }
    </script>
  </body>
</html>
